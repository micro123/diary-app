<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             xmlns:u="https://irihi.tech/ursa"
             xmlns:i="https://github.com/projektanker/icons.avalonia"
             xmlns:models="clr-namespace:Diary.App.Models"
             xmlns:app="clr-namespace:Diary.App"
             x:CompileBindings="False"
             x:Class="Diary.App.Views.StatisticsView">
    <Panel>
        <TextBlock Text="数据库连接出错，需要检查设置" HorizontalAlignment="Center" VerticalAlignment="Center"
                   FontSize="64"
                   IsVisible="{Binding !DatabaseOk, Source={x:Static app:App.Current}}" />
        <TabControl ItemsSource="{Binding Tabs}" TabStripPlacement="Top"
                    Theme="{DynamicResource ScrollTabControl}"
                    IsVisible="{Binding DatabaseOk, Source={x:Static app:App.Current}}">
            <TabControl.Styles>
                <Style Selector="CalendarDatePicker">
                    <Setter Property="Width" Value="140" />
                    <Setter Property="Foreground" Value="{DynamicResource ButtonDefaultPrimaryForeground}" />
                    <Style Selector="^:disabled /template/ TextBox#PART_TextBox:disabled">
                        <Setter Property="Foreground" Value="{DynamicResource ButtonDefaultPrimaryForeground}" />
                    </Style>
                </Style>
            </TabControl.Styles>
            <TabControl.ItemTemplate>
                <DataTemplate DataType="models:StatisticsTabData">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <i:Icon Value="{Binding Icon}" FontSize="16" />
                        <TextBlock Text="{Binding Name}" Classes="H5"
                                   VerticalAlignment="Center"
                                   Theme="{DynamicResource TitleTextBlock}" />
                        <Button Theme="{DynamicResource BorderlessButton}" IsVisible="{Binding !IsCustom}">
                            <i:Icon Value="fa-circle-xmark" />
                        </Button>
                    </StackPanel>
                </DataTemplate>
            </TabControl.ItemTemplate>
            <TabControl.ContentTemplate>
                <DataTemplate DataType="models:StatisticsTabData">
                    <DockPanel VerticalSpacing="4" HorizontalSpacing="4">
                        <!-- 日期显示 -->
                        <StackPanel Orientation="Horizontal" Spacing="4" DockPanel.Dock="Top">
                            <TextBlock Text="从" VerticalAlignment="Center" />
                            <CalendarDatePicker SelectedDate="{Binding DateBegin}"
                                                VerticalAlignment="Center" IsEnabled="{Binding IsCustom}"
                                                Text="{Binding DateBegin, Converter={StaticResource DateConvert}}" />
                            <TextBlock Text="至" VerticalAlignment="Center" />
                            <CalendarDatePicker SelectedDate="{Binding DateEnd}"
                                                VerticalAlignment="Center" IsEnabled="{Binding IsCustom}"
                                                Text="{Binding DateEnd, Converter={StaticResource DateConvert}}" />
                            <Button Classes="Primary" Theme="{DynamicResource FlatButton}"
                                    Command="{Binding RefreshCommand}">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <i:Icon Value="fa-rotate" FontSize="16" />
                                    <TextBlock Text="重新统计" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                        </StackPanel>
                        <!-- 自定义工时 -->
                        <StackPanel Orientation="Horizontal" Spacing="4" DockPanel.Dock="Top">
                            <CheckBox Content="使用自定义总时间" IsChecked="{Binding UseCustomTime}"
                                      VerticalAlignment="Center" />
                            <u:NumericDoubleUpDown ShowButtonSpinner="False" Value="{Binding CustomTotal}"
                                                   IsEnabled="{Binding UseCustomTime}" Width="100"
                                                   InnerRightContent="小时" />
                            <TextBlock Text="{Binding StatisticsTotal, StringFormat='统计总工时：{0:0.##} 小时'}"
                                       VerticalAlignment="Center" />
                        </StackPanel>
                        <u:Divider DockPanel.Dock="Top" />
                        <!-- 图表 -->
                        <ContentControl Content="{Binding Chart}" MinWidth="600"
                                        DockPanel.Dock="Left" />
                        <!-- 表格 -->
                        <TreeDataGrid Source="{Binding TimeDetails}" CanUserResizeColumns="False"
                                      CanUserSortColumns="False" x:Name="TimeTable">
                            <TreeDataGrid.Styles>
                                <Style Selector="TreeDataGridRow">
                                    <Style Selector="^ /template/ Border#RowBorder">
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="Focusable" Value="False"/>
                                    </Style>
                                    <Style Selector="^:pointerover /template/ Border#RowBorder">
                                        <Setter Property="Background" Value="{DynamicResource SemiColorFill1}" />
                                    </Style>
                                    <Style Selector="^:selected">
                                        <Style Selector="^ /template/ TreeDataGridCellsPresenter#PART_CellsPresenter">
                                            <Setter Property="Background" Value="Transparent"/>
                                        </Style>
                                        <Style Selector="^ /template/ Border#RowBorder">
                                            <Setter Property="Background" Value="{DynamicResource SemiColorPrimaryLight}" />
                                        </Style>
                                        <Style Selector="^:pointerover /template/ Border#RowBorder">
                                            <Setter Property="Background" Value="{DynamicResource SemiColorPrimaryLightPointerover}" />
                                        </Style>
                                        <Style Selector="^:focus /template/ Border#RowBorder">
                                            <Setter Property="Background" Value="{DynamicResource SemiColorPrimaryLight}" />
                                        </Style>
                                        <Style Selector="^:pointerover:focus /template/ Border#RowBorder">
                                            <Setter Property="Background" Value="{DynamicResource SemiColorPrimaryLightPointerover}" />
                                        </Style>
                                    </Style>
                                </Style>
                            </TreeDataGrid.Styles>
                            <TreeDataGrid.Resources>
                                <DataTemplate DataType="models:StatisticsTimeNode" x:Key="OperationsCell">
                                    <Button Content="详细" Command="{Binding $parent[TreeDataGrid].((models:StatisticsTabData)DataContext).ShowTagDetailsCommand}"
                                            CommandParameter="{Binding}"
                                            IsVisible="{Binding CanShowDetails}"/>
                                </DataTemplate>
                            </TreeDataGrid.Resources>
                        </TreeDataGrid>
                    </DockPanel>
                </DataTemplate>
            </TabControl.ContentTemplate>
        </TabControl>
    </Panel>
</UserControl>