<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             xmlns:u="https://irihi.tech/ursa"
             xmlns:lvc="using:LiveChartsCore.SkiaSharpView.Avalonia"
             xmlns:i="https://github.com/projektanker/icons.avalonia"
             xmlns:viewModels="clr-namespace:Diary.App.ViewModels"
             xmlns:ftdg="using:FastTreeDataGrid.Control.Controls"
             xmlns:models="clr-namespace:Diary.App.Models"
             xmlns:app="clr-namespace:Diary.App"
             x:CompileBindings="False"
             x:Class="Diary.App.Views.StatisticsView">
    <Panel>
        <TextBlock Text="数据库连接出错，需要检查设置" HorizontalAlignment="Center" VerticalAlignment="Center"
                   FontSize="64"
                   IsVisible="{Binding !DatabaseOk, Source={x:Static app:App.Current}}" />
        <TabControl ItemsSource="{Binding Tabs}" TabStripPlacement="Top"
                    Theme="{DynamicResource ScrollTabControl}"
                    IsVisible="{Binding DatabaseOk, Source={x:Static app:App.Current}}">
            <TabControl.Styles>
                <Style Selector="CalendarDatePicker">
                    <Setter Property="Width" Value="140" />
                    <!-- <Setter Property="Text" Value="{Binding $self.SelectedDate, Converter={StaticResource DateConvert}}"/> -->
                    <Setter Property="Foreground" Value="{DynamicResource ButtonDefaultPrimaryForeground}" />
                    <Style Selector="^:disabled /template/ TextBox#PART_TextBox:disabled">
                        <Setter Property="Foreground" Value="{DynamicResource ButtonDefaultPrimaryForeground}" />
                    </Style>
                </Style>
            </TabControl.Styles>
            <TabControl.ItemTemplate>
                <DataTemplate DataType="models:StatisticsTabData">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <i:Icon Value="{Binding Icon}" FontSize="16" />
                        <TextBlock Text="{Binding Name}" Classes="H5"
                                   VerticalAlignment="Center"
                                   Theme="{DynamicResource TitleTextBlock}" />
                        <Button Theme="{DynamicResource BorderlessButton}" IsVisible="{Binding !IsCustom}">
                            <i:Icon Value="fa-circle-xmark" />
                        </Button>
                    </StackPanel>
                </DataTemplate>
            </TabControl.ItemTemplate>
            <TabControl.ContentTemplate>
                <DataTemplate DataType="models:StatisticsTabData">
                    <DockPanel VerticalSpacing="4" HorizontalSpacing="4">
                        <!-- 日期显示 -->
                        <StackPanel Orientation="Horizontal" Spacing="4" DockPanel.Dock="Top">
                            <TextBlock Text="从" VerticalAlignment="Center" />
                            <CalendarDatePicker SelectedDate="{Binding DateBegin}"
                                                VerticalAlignment="Center" IsEnabled="{Binding IsCustom}"
                                                Text="{Binding DateBegin, Converter={StaticResource DateConvert}}" />
                            <TextBlock Text="至" VerticalAlignment="Center" />
                            <CalendarDatePicker SelectedDate="{Binding DateEnd}"
                                                VerticalAlignment="Center" IsEnabled="{Binding IsCustom}"
                                                Text="{Binding DateEnd, Converter={StaticResource DateConvert}}" />
                            <Button Classes="Primary" Theme="{DynamicResource FlatButton}"
                                    Command="{Binding RefreshCommand}">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <i:Icon Value="fa-rotate" FontSize="16" />
                                    <TextBlock Text="重新统计" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                        </StackPanel>
                        <!-- 自定义工时 -->
                        <StackPanel Orientation="Horizontal" Spacing="4" DockPanel.Dock="Top">
                            <CheckBox Content="使用自定义总时间" IsChecked="{Binding UseCustomTime}"
                                      VerticalAlignment="Center" />
                            <u:NumericDoubleUpDown ShowButtonSpinner="False" Value="{Binding CustomTotal}"
                                                   IsEnabled="{Binding UseCustomTime}" Width="100"
                                                   InnerRightContent="小时" />
                            <TextBlock Text="{Binding StatisticsTotal, StringFormat='统计总工时：{0:0.##} 小时'}"
                                       VerticalAlignment="Center" />
                        </StackPanel>
                        <u:Divider DockPanel.Dock="Top" />
                        <!-- 图表 -->
                        <ContentControl Content="{Binding Chart}" MinWidth="600"
                                        DockPanel.Dock="Left" />
                        <!-- 表格 -->
                        <ftdg:FastTreeDataGrid ItemsSource="{Binding TimeDetails}"
                                               RowHeight="32" SelectionMode="None" HeaderHeight="32"
                                               IsFilterRowVisible="False">
                            <ftdg:FastTreeDataGrid.Columns>
                                <FastTreeDataGridColumn Header="标签" SizingMode="Star" CanUserSort="False"
                                                        IsReadOnly="True" IsHierarchy="True" ValueKey="Name">
                                    <FastTreeDataGridColumn.CellTemplate>
                                        <WidgetTemplate>
                                            <FormattedTextWidget Key="Name" EmSize="14" Trimming="CharacterEllipsis"/>
                                        </WidgetTemplate>
                                    </FastTreeDataGridColumn.CellTemplate>
                                </FastTreeDataGridColumn>
                                <FastTreeDataGridColumn Header="耗时" SizingMode="Pixel" CanUserSort="False"
                                                        IsReadOnly="True" PixelWidth="80">
                                    <FastTreeDataGridColumn.CellControlTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Item.Time}" />
                                        </DataTemplate>
                                    </FastTreeDataGridColumn.CellControlTemplate>
                                </FastTreeDataGridColumn>
                                <FastTreeDataGridColumn Header="占比" SizingMode="Pixel" CanUserSort="False"
                                                        IsReadOnly="True" PixelWidth="80">
                                    <FastTreeDataGridColumn.CellControlTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Item.Percent}" />
                                        </DataTemplate>
                                    </FastTreeDataGridColumn.CellControlTemplate>
                                </FastTreeDataGridColumn>
                            </ftdg:FastTreeDataGrid.Columns>
                        </ftdg:FastTreeDataGrid>
                    </DockPanel>
                </DataTemplate>
            </TabControl.ContentTemplate>
        </TabControl>
    </Panel>
</UserControl>